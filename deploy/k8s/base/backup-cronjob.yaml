apiVersion: batch/v1
kind: CronJob
metadata:
  name: mc-backup
spec:
  schedule: "0 4 * * *"   # 毎朝4時
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: backup
              image: minio/mc:latest

              env:
                - name: S3_ENDPOINT
                  valueFrom:
                    secretKeyRef:
                      name: mc-s3
                      key: ENDPOINT
                - name: S3_BUCKET
                  valueFrom:
                    secretKeyRef:
                      name: mc-s3
                      key: BUCKET
                - name: S3_PREFIX
                  valueFrom:
                    secretKeyRef:
                      name: mc-s3
                      key: PREFIX
                - name: S3_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: mc-s3
                      key: ACCESS_KEY
                - name: S3_SECRET_KEY
                  valueFrom:
                    secretKeyRef:
                      name: mc-s3
                      key: SECRET_KEY

              volumeMounts:
                - name: data
                  mountPath: /data

              command:
                - /bin/sh
                - -c
                - |
                  echo "=== Minecraft World Backup ==="

                  mc alias set s3 "${S3_ENDPOINT}" "${S3_ACCESS_KEY}" "${S3_SECRET_KEY}"

                  DATE=$(date +"%Y-%m-%d_%H-%M-%S")
                  FILENAME="world-${DATE}.tar.gz"

                  echo "Creating archive ${FILENAME}"
                  tar -czf "/tmp/${FILENAME}" /data/world > /dev/null

                  echo "Uploading..."
                  mc cp "/tmp/${FILENAME}" "s3/${S3_BUCKET}/${S3_PREFIX}/${FILENAME}"

                  echo "Backup completed"

          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: mc-data
