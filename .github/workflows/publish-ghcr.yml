name: build-minecraft-images

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: alexandergg-0520/minecraft-server

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target:
          - runtime-jre8
          - runtime-jre11
          - runtime-jre17
          - runtime-jre21
          - runtime-jre25
          - runtime-jre25-gpu

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------
      # Install BuildKit (standalone)
      # -----------------------------
      - name: Install BuildKit
        run: |
          BUILDKIT_VERSION=v0.13.2
          curl -L https://github.com/moby/buildkit/releases/download/${BUILDKIT_VERSION}/buildkit-${BUILDKIT_VERSION}.linux-amd64.tar.gz \
            | tar -xz
          sudo mv bin/buildkitd bin/buildctl /usr/local/bin/

      # -----------------------------
      # Start buildkitd
      # -----------------------------
      - name: Start buildkitd
        run: |
          buildkitd \
            --addr unix:///run/buildkit/buildkitd.sock \
            --oci-worker-no-process-sandbox &
          sleep 3

      # -----------------------------
      # Login to GHCR (NO docker)
      # -----------------------------
      - name: Login to GHCR
        run: |
          buildctl login \
            --username "${{ github.actor }}" \
            --password "${{ secrets.GITHUB_TOKEN }}" \
            ${{ env.REGISTRY }}

      # -----------------------------
      # Build & Push (per target)
      # -----------------------------
      - name: Build & Push (${{ matrix.target }})
        run: |
          buildctl build \
            --frontend dockerfile.v0 \
            --local context=. \
            --local dockerfile=./Dockerfile \
            --opt target=${{ matrix.target }} \
            --output type=image,name=alexandergg-0520/minecraft-server:${{ matrix.target }},push=true
