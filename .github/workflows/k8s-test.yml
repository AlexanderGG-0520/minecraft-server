name: k8s-test

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  k8s-test:
    runs-on: ubuntu-latest

    strategy:
        matrix:
            type: [auto, vanilla, fabric, forge, neoforge]

    steps:
        -   name: Checkout
            uses: actions/checkout@v4

        -   name: Set up Docker
            uses: docker/setup-buildx-action@v3
        -   name: Build image
            run: |
                docker build -t mc-server:test .
        -   name: Create kind cluster
            uses: helm/kind-action@v1.10.0
            with:
                cluster_name: mc-test
        -   name: Load image into kind
            run: |
                kind load docker-image mc-server:test --name mc-test
        -   name: Apply pod
            run: kubectl apply -f test/k8s/pod.yaml

        -   name: Wait a bit
            run: sleep 30

        -   name: Show logs
            run: kubectl logs mc-test
        -   name: EULA false should fail
            run: |
                kubectl delete pod mc-test --ignore-not-found
                kubectl apply -f test/k8s/pod-eula-false.yaml