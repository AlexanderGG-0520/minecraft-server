name: Docker Main Flow Test

on:
  push:
  pull_request:

jobs:
  main-flow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------
      # 1. entrypoint.sh 構文チェック
      # -----------------------------
      - name: Bash syntax check
        run: bash -n entrypoint.sh

      # -----------------------------
      # 2. Docker build (pushしない)
      # -----------------------------
      - name: Build Docker image (java21)
        run: |
          docker build \
            -f Dockerfile.jre21 \
            -t mc:test-jre21 \
            .

      # -----------------------------
      # 3. Java スモークテスト
      # -----------------------------
      - name: Java smoke test
        run: |
          docker run --rm mc:test-java21 java -version

      # -----------------------------
      # 4. main フロー実行（CI最小構成）
      # -----------------------------
      - name: Run main flow (CI minimal world)
        run: |
          set +e

          DATA_DIR="$(mktemp -d)"

          docker run --rm \
            -e EULA=true \
            -e TYPE=auto \
            -e READY_DELAY=1 \
            -e JVM_XMS=64M \
            -e JVM_XMX=64M \
            -e MODS_ENABLED=false \
            -e CONFIGS_ENABLED=false \
            -e PLUGINS_ENABLED=false \
            -e DATAPACKS_ENABLED=false \
            -e RESOURCEPACKS_ENABLED=false \
            -e OPTIMIZE_MODE=off \
            -v "${DATA_DIR}:/data" \
            mc:test-java21

          EXIT_CODE=$?
          set -e

          echo "Container exited with code: ${EXIT_CODE}"

          # main が runtime まで到達すればOK
          # dummy server.jar なので非0終了は「想定内成功」
          test "${EXIT_CODE}" -ne 0
